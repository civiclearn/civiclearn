<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title data-i18n="title_traps">Frequent Traps</title>

  <!-- Core Styles -->
  <link rel="stylesheet" href="/assets/css/dashboard-core-lt.css">
  <link rel="stylesheet" href="/assets/css/test-core.css">
  <!-- Flag size override -->
  <style>
    .brand svg {
      width: 30px !important;
      height: 30px !important;
    }
  </style>
  
<script>
  document.documentElement.classList.add("i18n-hidden");
</script>
<script type="module" src="/assets/js/auth-guard.js"></script>

</head>

<body class="test-page">

  <!-- MOBILE MENU -->
  <button class="menu-toggle" aria-label="Menu">☰</button>

  <div class="wrap">

    <!-- SIDEBAR -->
    <aside class="sidebar">

<div class="brand">
  CivicLearn®
  <svg
    viewBox="0 0 12000 6000"
    width="30"
    height="30"
    style="margin-left:6px;vertical-align:middle;border-radius:3px;overflow:hidden"
    aria-label="Lithuania"
  >
    <defs>
      <clipPath id="clip-lt">
        <rect width="12000" height="6000" />
      </clipPath>
    </defs>

    <g clip-path="url(#clip-lt)">
      <!-- Top: Yellow -->
      <rect x="0" y="0" width="12000" height="2000" fill="#FDB913"/>

      <!-- Middle: Green -->
      <rect x="0" y="2000" width="12000" height="2000" fill="#006A44"/>

      <!-- Bottom: Red -->
      <rect x="0" y="4000" width="12000" height="2000" fill="#C1272D"/>
    </g>
  </svg>
</div>



      <nav class="nav">
  <a href="index.html"  data-i18n="nav_dashboard"></a>
  <a href="simulation.html" data-i18n="nav_simulation"></a>
  <a href="quick.html" data-i18n="nav_quick"></a>
  <a href="topics.html" data-i18n="nav_topics"></a>
  <a href="traps.html" class="sub active" data-i18n="nav_traps"></a>
  <a href="flashcards.html" data-i18n="nav_flashcards"></a>
  <a href="history.html" data-i18n="nav_history"></a>
  <a href="help.html" data-i18n="nav_help"></a>
  <a href="#" data-i18n="nav_logout" id="logoutLink"></a>
</nav>

      
<div class="spacer"></div>
<div class="profile">

  <!-- GLOBAL CONTROLS -->
  <div class="global-controls">

    <!-- LANGUAGE SWITCH -->
    <div class="lang-switch">
      <button data-lang="lt">LT</button>
      <button data-lang="ru">RU</button>
      <button data-lang="en">EN</button>
    </div>

    <!-- READING ASSIST (SVG) -->
    <button
      id="readingToggle"
      class="reading-btn tool"
      data-i18n="reading_tooltip"
      data-i18n-attr="title"
      aria-label="Reading assist"
    >
      <svg class="reading-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 9v6h4l5 5V4L7 9H3z"/>
        <path d="M16.5 12l4.5 4.5-1.5 1.5L15 13.5l-4.5 4.5-1.5-1.5L13.5 12 9 7.5 10.5 6l4.5 4.5 4.5-4.5 1.5 1.5L16.5 12z"/>
      </svg>
    </button>

  </div>

</div>

</aside>

    <!-- OVERLAY -->
    <div class="overlay" id="menuOverlay"></div>

    <!-- MAIN -->
    <main>

      <header class="ce-header ce-header-top">
        <h1 data-i18n="title_traps"></h1>
      </header>
	  <div class="ce-progress-global">
  <div class="ce-progress-global-bar" id="trapsProgress"></div>
</div>

      <div class="quiz-container" id="quizArea">
        <div id="quiz"></div>
      </div>

    </main>

  </div>

<!-- CONFIG + I18N -->
<script src="/assets/js/lang-bootstrap.js"></script>
<script src="/assets/js/config-lt.js"></script>
<script src="/assets/js/i18n.js"></script>
<script>
  CivicLearnI18n.init();
</script>
<script src="/assets/js/reading.js"></script>
<script src="/assets/js/engine-lt.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // MOBILE MENU (can run immediately)
  const toggle = document.querySelector(".menu-toggle");
  const overlay = document.getElementById("menuOverlay");
  if (toggle && overlay) {
    toggle.addEventListener("click", () => {
      document.body.classList.toggle("menu-open");
    });
    overlay.addEventListener("click", () => {
      document.body.classList.remove("menu-open");
    });
  }

  // Everything that needs translations waits for i18n
  CivicLearnI18n.onReady(async () => {

    /* THEME */
    try {
      const s = JSON.parse(localStorage.getItem("civicedge_settings") || "{}");
      if (s.theme) document.documentElement.dataset.theme = s.theme;
    } catch {}

    /* LOAD BANK */
    const bankPath = window.CIVICEDGE_CONFIG?.bank?.path;
    if (!bankPath) {
      console.error("Config error: missing bank path");
      return;
    }

    let fullBank = [];
    try {
      const res = await fetch(bankPath);
      const raw = await res.json();
      fullBank = Array.isArray(raw) ? raw : (raw.questions || []);
    } catch (err) {
      console.error("Bank load error", err);
      return;
    }

    /* GET TRICKY QUESTIONS (with normalization) */
    let progress = {};
    try {
      progress = JSON.parse(localStorage.getItem("civicedge_progress") || "{}");
    } catch {}

    const trickyKeys = Object.keys(progress)
      .filter(id => (progress[id].wrongs || 0) >= 3 && (progress[id].rights || 0) < 2);

    function normalizeLabel(str) {
      return (str || "")
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .replace(/^l['’]\s*/i, "")
        .replace(/^(le|la|les)\s+/i, "")
        .toLowerCase()
        .trim()
        .replace(/\s+/g, " ");
    }

    const normalizedTrickySet = new Set(
      trickyKeys.map(k => {
        const [topic, ...rest] = k.split(":");
        const text = rest.join(":");
        return `${normalizeLabel(topic)}:${text.trim()}`;
      })
    );

    const trickySet = fullBank.filter(q => {
const topicLT =
  q.topic && typeof q.topic === "object"
    ? q.topic.lt
    : q.topic;

const qTextLT =
  q.q && typeof q.q === "object"
    ? q.q.lt
    : q.q;

const qKeyNormalized =
  `${normalizeLabel(topicLT)}:${(qTextLT || "").trim()}`;

return normalizedTrickySet.has(qKeyNormalized);

    });

    const quizArea = document.getElementById("quizArea");

    if (trickySet.length === 0) {
      quizArea.innerHTML = `
        <div class="ce-card">
          <h2 data-i18n="traps_none_title"></h2>
          <p data-i18n="traps_none_body"></p>
        </div>`;
      CivicLearnI18n.apply();   // now translations are ready
      return;
    }

    /* START TRAPS MODE – now i18n is fully ready */
    CivicEdgeEngine.start("traps", {
      bank: trickySet,
      limit: 20,
      timed: false,
      simulation: false,
      recursive: false,
      showFeedback: true
    });
  });
});
</script>
<script>
  (function () {
    const current = window.CIVICEDGE_LANG;

    document.querySelectorAll(".lang-switch button").forEach(btn => {
      const lang = btn.dataset.lang;

      // Highlight active language
      if (lang === current) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", () => {
        if (lang === current) return;
        localStorage.setItem("civicedge_lang", lang);
        location.reload();
      });
    });
  })();
</script>
<script src="/assets/js/signout.js"></script>
</body>
</html>