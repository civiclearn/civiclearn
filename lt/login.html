
<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CivicLearn – Login</title>

  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/login.css">
<style>
/* =========================
   Language switcher (login)
========================= */

.lang-switch {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 16px;
}

.lang-switch button {
  width: 44px;
  height: 34px;
  border-radius: 10px;
  border: 1px solid #d8d6e3;
  background: #f6f5fb;
  color: #2d2b38;
  font-family: inherit;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
}

.lang-switch button:hover {
  background: #edeafc;
  border-color: #c8c3f5;
}

.lang-switch button.active {
  background: #6b4eff;
  color: #fff;
  border-color: #6b4eff;
  box-shadow: 0 4px 12px rgba(107, 78, 255, 0.25);
}
</style>


  <!-- Supabase config -->
  <script>
    window.SUPABASE_URL = "https://htgliokekeaovdiafrgs.supabase.co";
    window.SUPABASE_KEY = "sb_publishable_QWvR124i4h0hvQumyjBgDw_018SlMbp";
  </script>

  <!-- Supabase loader -->
  <script>
    (function () {
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.7.1/dist/umd/supabase.js";
      s.onload = () => {
        window.supabase = supabase.createClient(
          window.SUPABASE_URL,
          window.SUPABASE_KEY
        );
      };
      document.head.appendChild(s);
    })();
  </script>
</head>

<body>

<header class="site-header">
  <div class="header-inner">

    <div class="header-left">
      <div class="brand-main">
        <img src="/assets/images/lt.svg" alt="Lithuania">
        <div class="brand-title">CivicLearn Lietuva</div>
      </div>
      <div class="brand-powered">
        powered by <span>CivicLearn</span>
      </div>
    </div>

    <nav class="header-nav">
      <a href="/lt/" data-t="nav_home"></a>
      <a href="/lt/#presentation" data-t="nav_overview"></a>
      <a href="/lt/#pricing" data-t="nav_pricing"></a>
    </nav>

    <a href="/lt/checkout.html" class="btn-small-purple" data-t="nav_signup"></a>
  </div>
</header>

<div class="login-wrapper">
  <div class="card">
    <div class="lang-switch">
      <button data-lang="lt">LT</button>
      <button data-lang="en">EN</button>
      <button data-lang="ru">RU</button>
    </div>

    <h1 data-t="title"></h1>
    <p class="subtitle" data-t="subtitle"></p>

    <div id="emailSection">
      <label for="email" data-t="email_label"></label>
      <input id="email" type="email" placeholder="you@example.com" style="width:100%; box-sizing:border-box; padding:12px; border:2px solid #e5dfd2; border-radius:8px; margin-bottom:15px;" />
      <button type="button" class="login-btn" id="sendMagicLink" data-t="send_code"></button>
    </div>

    <div id="otpSection" style="display:none; margin-top: 10px;">
      <label for="otpCode" data-t="otp_label"></label>
      <input id="otpCode" type="text" placeholder="00000000" maxlength="8" />
      <button type="button" class="login-btn" id="verifyOtp" style="width:100%; margin-top:15px; background-color: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-weight:600; cursor:pointer;" data-t="verify_btn"></button>
    </div>

    <div id="loginMessage" class="login-message" style="display:none; margin-top:15px;"></div>

    <div class="login-footer">
      <span data-t="no_access"></span>
      <a href="/lt/checkout.html" data-t="create_access" style="color: #7c3aed; text-decoration: none; font-weight: 500;"></a>
    </div>
  </div>
</div>

<script>
const I18N = {
  lt: {
    title: "Prisijungimas",
    subtitle: "Įveskite el. paštą, kad gautumėte 8 skaitmenų prisijungimo kodą.",
    email_label: "El. pašto adresas",
    send_code: "Siųsti kodą",
    otp_label: "8 skaitmenų kodas",
    verify_btn: "Patvirtinti ir prisijungti",
    no_access: "Dar neturite prieigos?",
    create_access: "Sukurti prieigą",
    first_login: "Jūsų prieiga aktyvuota. Įveskite el. pašto adresą, naudotą pirkimo metu.",
    sent_once: "Jūsų 8 skaitmenų kodas išsiųstas. Patikrinkite el. paštą.",
    sent_twice: "Jei vis dar negavote kodo, patikrinkite Šlamštą arba susisiekite su mumis.",
    email_error: "Įveskite el. pašto adresą.",
    user_not_found: "Šis el. paštas nerastas — įveskite tikslų adresą, kurį naudojote pirkimo metu.",
    otp_error: "Įveskite galiojantį kodą iš savo el. pašto."
  },
  en: {
    title: "Login",
    subtitle: "Enter your email to receive your 8-digit access code.",
    email_label: "Email Address",
    send_code: "Send login code",
    otp_label: "8-Digit Code",
    verify_btn: "Verify & Login",
    no_access: "Don't have access yet?",
    create_access: "Create access",
    first_login: "Your access has been activated. Enter the email address used during purchase.",
    sent_once: "Your 8-digit login code has been sent. Please check your email.",
    sent_twice: "If you still haven't received the code, please check Spam or contact us.",
    email_error: "Please enter your email address.",
    user_not_found: "This email is not on file — please enter the exact email used during purchase.",
    otp_error: "Please enter the valid code sent to your email."
  },
  ru: {
    title: "Вход",
    subtitle: "Введите эл. почту, чтобы получить 8-значный код доступа.",
    email_label: "Эл. почта",
    send_code: "Отправить код",
    otp_label: "8-значный код",
    verify_btn: "Подтвердить и войти",
    no_access: "Ещё нет доступа?",
    create_access: "Получить доступ",
    first_login: "Доступ активирован. Введите эл. почту, использованную при оплате.",
    sent_once: "8-значный код отправлен. Проверьте почту.",
    sent_twice: "Если вы не получили код, проверьте Спам или свяжитесь с нами.",
    email_error: "Введите адрес эл. почты.",
    user_not_found: "Этот адрес не найден — введите тот, что использовали при покупке.",
    otp_error: "Введите действующий код из письма."
  }
};

let currentLang = "lt";

function applyLang(lang) {
  currentLang = lang;
  document.querySelectorAll("[data-t]").forEach(el => {
    const key = el.getAttribute("data-t");
    if (I18N[lang][key]) el.textContent = I18N[lang][key];
  });
  document.querySelectorAll(".lang-switch button").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === lang);
  });
}

document.querySelectorAll(".lang-switch button").forEach(btn => {
  btn.addEventListener("click", () => applyLang(btn.dataset.lang));
});

applyLang("lt");

function showMessage(type, text) {
  const box = document.getElementById("loginMessage");
  box.className = "login-message " + type;
  box.textContent = text;
  box.style.display = "block";
}

let lastEmailAttempt = "";
let attemptCount = 0;

document.getElementById("sendMagicLink").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  if (!email) { showMessage("error", I18N[currentLang].email_error); return; }
  
  const { error } = await window.supabase.auth.signInWithOtp({
    email,
    options: { shouldCreateUser: false }
  });

  if (error) {
    if (error.message.includes("Signups not allowed for otp")) {
      showMessage("error", I18N[currentLang].user_not_found);
    } else {
      showMessage("error", error.message);
    }
    return;
  }

  document.getElementById("emailSection").style.display = "none";
  document.getElementById("otpSection").style.display = "block";

  if (email === lastEmailAttempt) attemptCount++;
  else { attemptCount = 1; lastEmailAttempt = email; }

  showMessage("success", attemptCount >= 2 ? I18N[currentLang].sent_twice : I18N[currentLang].sent_once);
});

document.getElementById("verifyOtp").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  const token = document.getElementById("otpCode").value.trim();

  if (token.length < 6 || token.length > 8) {
    showMessage("error", I18N[currentLang].otp_error);
    return;
  }

  const { data, error } = await window.supabase.auth.verifyOtp({
    email,
    token,
    type: 'magiclink'
  });

  if (error) {
    showMessage("error", error.message);
  } else if (data.session) {
    window.location.href = "/lt/dashboard/index.html";
  }
});
</script>
</body>
</html>
