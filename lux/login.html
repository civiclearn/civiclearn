<!DOCTYPE html>
<html lang="fr-LU">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CivicLearn – Connexion</title>

  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/login.css">

  <!-- Supabase config -->
  <script>
    window.SUPABASE_URL = "https://htgliokekeaovdiafrgs.supabase.co";
    window.SUPABASE_KEY = "sb_publishable_QWvR124i4h0hvQumyjBgDw_018SlMbp";
  </script>

  <!-- Supabase loader -->
  <script>
    (function () {
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.7.1/dist/umd/supabase.js";
      s.onload = () => {
        window.supabase = supabase.createClient(
          window.SUPABASE_URL,
          window.SUPABASE_KEY
        );
      };
      document.head.appendChild(s);
    })();
  </script>
</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="brand-main">
        <img src="/assets/images/lu.svg" alt="Luxembourg">
        <div class="brand-title">Vivre-Ensemble</div>
      </div>
      <div class="brand-powered">
        powered by <span>CivicLearn</span>
      </div>
    </div>

<nav class="header-nav">
  <a href="https://vivre-ensemble.lu/">Accueil</a>
  <a href="https://vivre-ensemble.lu/contact/">Contact</a>
</nav>

 <a href="/lux/checkout.html"
   class="btn-small-purple"
   data-t="nav_signup">
  Je m’inscris
</a>
  </div>
</header>

<div class="login-wrapper">

  <div class="login-note-wrapper">

    <!-- PEEK TAB -->
    <button class="login-note-tab" id="noteToggle">
      Inscrit en 2025&nbsp;?
    </button>

    <!-- HIDDEN NOTE PANEL -->
    <div class="login-note-panel" id="loginNote">
      <p>
        <strong>Vous aviez déjà un compte Vivre-Ensemble.lu&nbsp;?</strong><br><br>
        Votre accès a été automatiquement transféré vers la nouvelle plateforme.<br>
        Entrez simplement l’adresse e-mail utilisée lors de votre inscription&nbsp;:
        vous recevrez immédiatement votre code d’accès par e-mail.
      </p>
    </div>

    <!-- LOGIN CARD -->
    <div class="card">

      <div class="lang-switch">
        <button data-lang="en">EN</button>
        <button data-lang="de">DE</button>
        <button data-lang="fr">FR</button>
      </div>

      <h1 data-t="title"></h1>
      <p class="subtitle" data-t="subtitle"></p>

    <div id="emailSection">
      <label for="email" data-t="email_label"></label>
      <input id="email" type="email" placeholder="name@example.lu" style="width:100%; box-sizing:border-box; padding:12px; border:2px solid #e5dfd2; border-radius:8px; margin-bottom:15px; font-family: 'Lexend', sans-serif;" />
      <button type="button" class="login-btn" id="sendMagicLink" data-t="send_code"></button>
    </div>

    <div id="otpSection" style="display:none; margin-top: 10px;">
      <label for="otpCode" data-t="otp_label"></label>
      <input id="otpCode" type="text" placeholder="00000000" maxlength="8" 
             style="width:100%; box-sizing:border-box; padding:12px; border:2px solid #e5dfd2; border-radius:8px; text-align:center; font-family: 'Courier New', Courier, monospace; font-size: 24px; letter-spacing: 4px; background:#fafafa;" />
      <button type="button" class="login-btn" id="verifyOtp" 
              style="width:100%; margin-top:15px; background-color: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-family: 'Lexend', sans-serif; font-weight:600; cursor:pointer;" data-t="verify_btn"></button>
    </div>

    <div id="loginMessage" class="login-message" style="display:none; margin-top:15px; font-family: 'Lexend', sans-serif;"></div>

    <div class="login-footer" style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; font-size: 13px; color: #666; text-align: center; font-family: 'Lexend', sans-serif;">
      <span data-t="no_access"></span>
      <a href="/lux/checkout.html" data-t="create_access" style="color: #7c3aed; text-decoration: none; font-weight: 500;"></a>
    </div>
  </div>
</div>

<script>
const I18N = {
  en: {
    title: "Login",
    subtitle: "Enter your email to receive your 8-digit access code.",
    email_label: "Email Address",
    send_code: "Send login code",
    otp_label: "8-Digit Code",
    verify_btn: "Verify & Login",
    no_access: "Don't have access yet?",
    create_access: "Create access",
    first_login: "Your access has been activated. Enter the email address used during purchase.",
    sent_once: "Your 8-digit code has been sent. Only the MOST RECENT code is valid. Do not request another one while entering it.",
    sent_twice: "If you still haven't received the code, please check Spam or contact us.",
    email_error: "Please enter your email address.",
    user_not_found: "This email is not on file — please enter the exact email used during purchase.",
    otp_error: "Please enter the valid code sent to your email."
  },
  de: {
    title: "Anmelden",
    subtitle: "Geben Sie Ihre E-Mail ein, um Ihren 8-stelligen Zugangscode zu erhalten.",
    email_label: "E-Mail-Adresse",
    send_code: "Anmeldecode senden",
    otp_label: "8-stelliger Code",
    verify_btn: "Bestätigen & Anmelden",
    no_access: "Noch keinen Zugang?",
    create_access: "Zugang erstellen",
    first_login: "Ihr Zugang wurde aktiviert. Geben Sie die beim Kauf verwendete E-Mail-Adresse ein.",
    sent_once: "Ihr 8-stelliger Code wurde gesendet. Nur der ZULETZT erhaltene Code ist gültig. Fordern Sie keinen neuen Code an, während Sie ihn eingeben.",
    sent_twice: "Wenn Sie den Code noch nicht erhalten haben, prüfen Sie den Spam-Ordner oder kontaktieren Sie uns.",
    email_error: "Bitte geben Sie Ihre E-Mail-Adresse ein.",
    user_not_found: "Diese E-Mail ist nicht registriert – bitte geben Sie die E-Mail-Adresse ein, die Sie beim Kauf verwendet haben.",
    otp_error: "Bitte geben Sie den gültigen Code ein, der an Ihre E-Mail gesendet wurde."
  },
  fr: {
    title: "Connexion",
    subtitle: "Saisissez votre e-mail pour recevoir votre code d'accès à 8 chiffres.",
    email_label: "Adresse e-mail",
    send_code: "Envoyer le code",
    otp_label: "Code à 8 chiffres",
    verify_btn: "Vérifier et se connecter",
    no_access: "Pas encore d'accès ?",
    create_access: "Créer un accès",
    first_login: "Votre accès a été activé. Entrez l'e-mail utilisé lors de l'achat.",
    sent_once: "Votre code à 8 chiffres a été envoyé. Seul le DERNIER code reçu est valable. Ne demandez pas un nouveau code pendant la saisie.",
    sent_twice: "Si vous n'avez toujours pas reçu le code, vérifiez vos spams ou contactez-nous.",
    email_error: "Veuillez entrer votre adresse e-mail.",
    user_not_found: "Cet e-mail n'est pas répertorié — veuillez saisir l'e-mail exact utilisé lors de l'achat.",
    otp_error: "Veuillez entrer le code valide envoyé par e-mail."
  }
};

let currentLang = "en";

function applyLang(lang) {
  currentLang = lang;
  document.querySelectorAll("[data-t]").forEach(el => {
    const key = el.getAttribute("data-t");
    if (I18N[lang][key]) el.textContent = I18N[lang][key];
  });
  document.querySelectorAll(".lang-switch button").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === lang);
  });
}

document.querySelectorAll(".lang-switch button").forEach(btn => {
  btn.addEventListener("click", () => applyLang(btn.dataset.lang));
});

// Default to EN for Luxembourg universal
applyLang("en");

function showMessage(type, text) {
  const box = document.getElementById("loginMessage");
  box.className = "login-message " + type;
  box.textContent = text;
  box.style.display = "block";
}

let lastEmailAttempt = "";
let attemptCount = 0;

document.getElementById("sendMagicLink").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  if (!email) { showMessage("error", I18N[currentLang].email_error); return; }
  
  const { error } = await window.supabase.auth.signInWithOtp({
    email,
    options: { shouldCreateUser: false }
  });

  if (error) {
    if (error.message.includes("Signups not allowed for otp")) {
      showMessage("error", I18N[currentLang].user_not_found);
    } else {
      showMessage("error", error.message);
    }
    return;
  }

  document.getElementById("emailSection").style.display = "none";
  document.getElementById("otpSection").style.display = "block";

  if (email === lastEmailAttempt) attemptCount++;
  else { attemptCount = 1; lastEmailAttempt = email; }

  showMessage("success", attemptCount >= 2 ? I18N[currentLang].sent_twice : I18N[currentLang].sent_once);
});

document.getElementById("verifyOtp").addEventListener("click", async () => {
  const email = document.getElementById("email").value.trim();
  const token = document.getElementById("otpCode").value.trim();

  if (token.length < 6 || token.length > 8) {
    showMessage("error", I18N[currentLang].otp_error);
    return;
  }

  const { data, error } = await window.supabase.auth.verifyOtp({
    email,
    token,
    type: 'magiclink'
  });

  if (error) {
    showMessage("error", error.message);
  } else if (data.session) {
    window.location.href = "/lux/dashboard/index.html";
  }
});
</script>
<script>
  const noteToggle = document.getElementById("noteToggle");
  const noteWrapper = document.querySelector(".login-note-wrapper");

  noteToggle.addEventListener("click", () => {
    noteWrapper.classList.toggle("open");
  });
</script>


</body>
</html>
