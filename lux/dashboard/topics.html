<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="title_topics"></title>

  <!-- Core -->

  <link rel="stylesheet" href="/assets/css/dashboard-core-lt.css">
  <link rel="stylesheet" href="/assets/css/test-core-lu.css">
  

 
  <style>
    .brand svg {
      width: 30px !important;
      height: 30px !important;
    }

    /* --- Light chip UI --- */
#topicContainer{
  display:flex;
  font-family: inherit;
  flex-direction:column;
  gap:18px;
  margin:20px 0;
}

    .topic-chip {
      padding: 10px 16px;
	  font-family: inherit;
      font-weight: 400;
      font-size: 14px;
      border-radius: 18px;
      background: var(--card);
      border: 1px solid var(--line);
      cursor: pointer;
      font-size: 15px;
      user-select: none;
      transition: 0.15s ease;
    }

    .topic-chip:hover {
      background: rgba(0,0,0,0.04);
    }

    .topic-chip.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }

    #startBtn {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 10px;
      background: var(--brand);
      color: #fff;
      border: none;
      cursor: pointer;
      display: none; /* shown only after selection */
    }
	.topic-chip.mastered {
  background: #e0ffe4;
  border-color: #34c759;
  color: #0a7a2a;
}

/* --- Grouped layout (real topic ‚Üí microtopics) --- */
.topic-group{
  display:block;
  font-family: inherit;
}

.topic-group-title{
  display:flex;
  align-items:center;
  align-items: center;
  gap: 10px;
  margin:0 0 10px 0;
  font-size:15px;
  font-weight:600;
  color:var(--text, #111827);
}

.topic-group-badge {
  margin-left: 6px;

  padding: 4px 10px;
  border-radius: 999px;

  font-size: 13px;
  font-weight: 500;
  line-height: 1.4;

  background: rgba(99, 102, 241, 0.10); /* soft indigo */
  color: rgba(55, 48, 163, 0.85);

  display: inline-flex;
  align-items: center;
}


.topic-chips{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}

/* count inside chip */
.topic-chip .chip-count {
  margin-left: 10px;

  padding: 2px 8px;
  border-radius: 999px;

  font-size: 12px;
  font-weight: 500;
  line-height: 1.4;

  background: rgba(99, 102, 241, 0.08); /* soft indigo */
  color: rgba(55, 48, 163, 0.85);

  display: inline-flex;
  align-items: center;
}
.topic-chip.active .chip-count {
  background: rgba(99, 102, 241, 0.15);
  color: rgba(55, 48, 163, 1);
}
.topic-chip:hover .chip-count {
  background: rgba(99, 102, 241, 0.12);
}
.topic-chip.active .chip-count {
  background: rgba(255, 255, 255, 0.28);
  color: #ffffff;
  font-weight: 600;
}

}

  </style>
        <script>
  document.documentElement.classList.add("i18n-hidden");
</script>
 <script type="module" src="/assets/js/auth-guards.js"></script>
</head>

<body class="test-page">

<button class="menu-toggle" aria-label="Menu">‚ò∞</button>

<div class="wrap">

  <!-- SIDEBAR -->
  <aside class="sidebar">
<div class="brand">
  CivicLearn¬Æ
  <svg
    viewBox="0 0 12000 6000"
    width="30"
    height="30"
    style="margin-left:6px;vertical-align:middle;border-radius:3px;overflow:hidden"
    aria-label="Luxembourg"
  >
    <defs>
      <clipPath id="clip-lu">
        <rect width="12000" height="6000" />
      </clipPath>
    </defs>

    <g clip-path="url(#clip-lu)">
      <!-- Top: Red -->
      <rect x="0" y="0" width="12000" height="2000" fill="#ED2939"/>

      <!-- Middle: White -->
      <rect x="0" y="2000" width="12000" height="2000" fill="#FFFFFF"/>

      <!-- Bottom: Light Blue -->
      <rect x="0" y="4000" width="12000" height="2000" fill="#00A1DE"/>
    </g>
  </svg>
</div>


              <nav class="nav">
  <a href="index.html"  data-i18n="nav_dashboard"></a>
  <a href="simulation.html" data-i18n="nav_simulation"></a>
  <a href="quick.html" data-i18n="nav_quick"></a>
  <a href="topics.html" class="sub active" data-i18n="nav_topics"></a>
  <a href="traps.html" data-i18n="nav_traps"></a>
  <a href="flashcards.html" data-i18n="nav_flashcards"></a>
  <a href="reference.html"  data-i18n="nav_reference_texts"></a>
  <a href="history.html" data-i18n="nav_history"></a>
  <a href="my-list.html" data-i18n="nav_my_list"></a>
  <a href="help.html" data-i18n="nav_help"></a>
  <a href="#" data-i18n="nav_logout" id="logoutLink"></a>
</nav>

    <div class="spacer"></div>

<div class="profile">


    <!-- LANGUAGE SWITCHER -->
<div class="lang-switch">
  <button data-lang="fr">FR</button>
  <button data-lang="de">DE</button>
  <button data-lang="en">EN</button>
</div>

 <div class="profile-info">

    <!-- READING TOGGLE -->
    <div class="reading-inline">
      <span data-i18n="reading_label"></span>
      <button id="readingToggle"
              class="reading-btn inline"
              data-i18n="reading_tooltip"
              data-i18n-attr="title">üîá</button>
    </div>

  </div>
</div>
  </aside>

  <!-- OVERLAY -->
  <div class="overlay" id="menuOverlay"></div>

  <!-- MAIN -->
  <main class="main">

    <header class="ce-header ce-header-top">
      <h1 data-i18n="title_topics"></h1>
      
    </header>

<div class="quiz-container" id="quizArea" style="display:none;">
	<div class="ce-progress-global">
  <div class="ce-progress-global-bar" id="topicsProgress"></div>
</div>
  <div id="quiz"></div>
</div>

    <section>

      <div id="topicContainer"></div>

      <button id="startBtn" data-i18n="topics_start_btn"></button>

    </section>
  </main>
</div>

<!-- CONFIG + I18N -->
<script src="/assets/js/lang-bootstrap-lu.js"></script>
<script src="/assets/js/config-lu.js"></script>
<script src="/assets/js/i18n.js"></script>
<script>
  CivicLearnI18n.init();
</script>

<!-- READING (must come BEFORE engine.js) -->
<script src="/assets/js/reading.js"></script>

<!-- ENGINE -->
<script src="/assets/js/engine-lu.js"></script>

<!-- MAIN TOPICS LOGIC -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const cfg = window.CIVICEDGE_CONFIG || {};
 
  const container = document.getElementById("topicContainer");
  const startBtn = document.getElementById("startBtn");
  const selected = new Set();

  const bankPath = cfg.bank && cfg.bank.path;
  const lang = window.CIVICEDGE_LANG || "fr";

  function normalizeLabel(str) {
    return (str || "")
      .normalize("NFD")
      .replace(/\p{Diacritic}/gu, "")
      .toLowerCase()
      .trim()
      .replace(/\s+/g, " ");
  }

  function getTopicLabel(q) {
    if (!q || !q.topic) return "";
    if (typeof q.topic === "object") {
      return q.topic[lang] || q.topic.en || "";
    }
    return q.topic;
  }
function isTopicMastered(microCanon, progress) {
  // supports both known progress shapes: progress.topics[...] and progress.microtopics[...]
  const node =
    (progress && progress.topics && progress.topics[microCanon]) ||
    (progress && progress.microtopics && progress.microtopics[microCanon]) ||
    (progress && progress[microCanon]) ||
    null;

  if (!node) return false;

  const seen = Number(node.seen ?? node.total ?? node.attempts ?? 0);
  const correct = Number(node.correct ?? node.right ?? 0);

  // conservative mastery rule (matches ‚Äúgreen when completed‚Äù behavior)
  // - must have been seen at least once
  // - and be mostly correct
  if (seen <= 0) return false;

  const rate = seen > 0 ? correct / seen : 0;
  return rate >= 0.8;
}

  async function loadBankTopics() {
    if (!bankPath) return [];

    try {
      const res = await fetch(bankPath);
      const raw = await res.json();
      return Array.isArray(raw) ? raw : (raw.questions || []);
    } catch (e) {
      console.warn("Failed to load bank for topics", e);
      return [];
    }
  }

  async function initTopics() {
    const bankQuestions = await loadBankTopics();
	
	const microtopics = new Map();

bankQuestions.forEach(q => {
  if (!q.microtopic || typeof q.microtopic !== "object") return;

  const canon = q.microtopic.en;
  if (!canon) return;

  if (!microtopics.has(canon)) {
    microtopics.set(canon, q.microtopic[lang] || canon);
  }
});


    // Build map: LT canonical topic ‚Üí translated label
// Build map: canonical EN topic ‚Üí translated label
const topicLabelMap = {};
bankQuestions.forEach(q => {
  if (!q.topic || typeof q.topic !== "object") return;
  const canon = q.topic.en;
  if (!canon) return;
  if (!topicLabelMap[canon]) {
    topicLabelMap[canon] = q.topic[lang] || canon;
  }
});


    const progress = JSON.parse(
      localStorage.getItem("civicedge_progress") || "{}"
    );

// ===== GROUP QUESTIONS BY REAL TOPIC + MICROTOPIC =====
const groupedTopics = {};
// realTopicLabel -> { label, total, micros: { microCanon -> { label, count } } }

bankQuestions.forEach(q => {
  if (!q.topic || !q.microtopic) return;
  if (typeof q.topic !== "object" || typeof q.microtopic !== "object") return;

  const realCanon = q.topic.en;
  if (!realCanon) return;

  const realLabel = q.topic[lang] || realCanon;
  const microCanon = q.microtopic.en;
  const microLabel = q.microtopic[lang] || microCanon;

  if (!microCanon) return;

  if (!groupedTopics[realCanon]) {
    groupedTopics[realCanon] = {
      label: realLabel,
      total: 0,
      micros: {}
    };
  }

  groupedTopics[realCanon].total++;

  if (!groupedTopics[realCanon].micros[microCanon]) {
    groupedTopics[realCanon].micros[microCanon] = {
      label: microLabel,
      count: 0
    };
  }

  groupedTopics[realCanon].micros[microCanon].count++;
});

// ===== RENDER GROUPED TOPICS =====
container.innerHTML = "";

Object.values(groupedTopics).forEach(group => {
  const groupWrap = document.createElement("div");
  groupWrap.className = "topic-group";

  const header = document.createElement("div");
  header.className = "topic-group-title";
  header.innerHTML = `
    <span>${group.label}</span>
    <span class="topic-group-badge">${group.total}</span>
  `;

  const chipsWrap = document.createElement("div");
  chipsWrap.className = "topic-chips";

  Object.entries(group.micros).forEach(([microCanon, mt]) => {
    const chip = document.createElement("button");
    chip.className = "topic-chip";	
	if (isMicrotopicMastered(microCanon, bankQuestions, progress)) {
  chip.classList.add("mastered");
}
	// apply mastered state using computed logic
if (typeof isTopicMastered === "function" && isTopicMastered(microCanon, progress)) {
  chip.classList.add("mastered");
}

   chip.dataset.topic = mt.label;

    chip.innerHTML = `
      ${mt.label}
      <span class="chip-count">${mt.count}</span>
    `;

    chip.addEventListener("click", () => {
  if (chip.classList.contains("active")) {
    chip.classList.remove("active");
    selected.delete(microCanon);
  } else {
    chip.classList.add("active");
    selected.add(microCanon);
  }

  startBtn.style.display =
    selected.size > 0 ? "inline-block" : "none";
});


    chipsWrap.appendChild(chip);
  });

  groupWrap.appendChild(header);
  groupWrap.appendChild(chipsWrap);
  container.appendChild(groupWrap);
});


    startBtn.addEventListener("click", () => {
  const pick = Array.from(selected).map(t => t);
  const limit =
    (cfg.topics && cfg.topics.questionCount) || 10;

  document.getElementById("quizArea").style.display = "block";
  document.querySelector("section").style.display = "none";

  let quiz = document.getElementById("quiz");
  if (!quiz) {
    quiz = document.createElement("div");
    quiz.id = "quiz";
    document.getElementById("quizArea").appendChild(quiz);
  }

  CivicEdgeEngine.start("topics", {
    topics: pick,
    limit: limit
  });

  window.scrollTo({ top: 0, behavior: "smooth" });
});

  }
function isMicrotopicMastered(microCanon, bankQuestions, progress) {
  const qs = bankQuestions.filter(
    q => q.microtopic && q.microtopic.en === microCanon
  );

  for (const q of qs) {
    const key = `${microCanon}:${q.id}`;
    const entry = progress[key];
    if (!(entry && entry.correct === 1)) {
      return false;
    }
  }
  return qs.length > 0;
}

  initTopics();
});
</script>

<!-- Menu -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.querySelector(".menu-toggle");
  const overlay = document.getElementById("menuOverlay");

  toggle.addEventListener("click", () => {
    document.body.classList.toggle("menu-open");
  });
  overlay.addEventListener("click", () => {
    document.body.classList.remove("menu-open");
  });
});
</script>
<script>
  (function () {
    const current = window.CIVICEDGE_LANG;

    document.querySelectorAll(".lang-switch button").forEach(btn => {
      const lang = btn.dataset.lang;

      // Highlight active language
      if (lang === current) {
        btn.classList.add("active");
      }

      btn.addEventListener("click", () => {
        if (lang === current) return;
        localStorage.setItem("civicedge_lang", lang);
        location.reload();
      });
    });
  })();
</script>
<script src="/assets/js/signout.js"></script>
</body>
</html>
